import streamlit as st
import google.generativeai as genai
from duckduckgo_search import DDGS

# ==========================================
# 0. ã‚¢ãƒ—ãƒªè¨­å®š
# ==========================================
st.set_page_config(page_title="K's Research Assistant", layout="wide", page_icon="ğŸ“")

st.title("ğŸ“ K's Research Assistant")
st.caption("Literature Search & Relevance Analysis | Powered by Gemini 1.5 Pro")

# ==========================================
# 1. ã‚µã‚¤ãƒ‰ãƒãƒ¼ (è¨­å®š)
# ==========================================
with st.sidebar:
    st.header("âš™ï¸ è¨­å®š")
    try:
        # æ—¢å­˜ã®SecretsãŒã‚ã‚Œã°ä½¿ã†ã€ãªã‘ã‚Œã°å…¥åŠ›
        api_key = st.secrets.get("GEMINI_API_KEY", None)
        if not api_key:
            api_key = st.text_input("Gemini API Key", type="password")
        else:
            st.success("API Key Loaded!")
    except:
        api_key = st.text_input("Gemini API Key", type="password")

    if api_key:
        genai.configure(api_key=api_key)

# ==========================================
# 2. ãƒ¡ã‚¤ãƒ³å…¥åŠ›ã‚¨ãƒªã‚¢
# ==========================================
col1, col2 = st.columns([1, 1])

with col1:
    st.subheader("ğŸ“Œ ã‚ãªãŸã®ç ”ç©¶ãƒ†ãƒ¼ãƒ")
    my_theme = st.text_area(
        "ç¾åœ¨ã®ç ”ç©¶å†…å®¹ãƒ»å®Ÿé¨“ãƒ†ãƒ¼ãƒãªã©ã‚’è©³ã—ãå…¥åŠ›",
        height=150,
        placeholder="ä¾‹ï¼š\nç½å®³æ™‚ã«ãŠã‘ã‚‹åœ¨å®…äººå·¥å‘¼å¸å™¨ã®é›»æºç¢ºä¿ã«é–¢ã™ã‚‹ç ”ç©¶ã€‚\nç‰¹ã«ã€ãƒãƒ¼ã‚¿ãƒ–ãƒ«é›»æºã¨ã‚½ãƒ¼ãƒ©ãƒ¼ãƒ‘ãƒãƒ«ã‚’çµ„ã¿åˆã‚ã›ãŸéš›ã®å®ŸåŠ¹ç¨¼åƒæ™‚é–“ã‚’å®Ÿæ¸¬ã—ã€é¿é›£æ‰€ã§ã®é‹ç”¨ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’ä½œæˆã—ãŸã„ã€‚"
    )

with col2:
    st.subheader("ğŸ” çŸ¥ã‚ŠãŸã„ã“ã¨ãƒ»æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰")
    search_query = st.text_area(
        "ä½•ã‚’èª¿ã¹ã¾ã™ã‹ï¼Ÿ",
        height=150,
        placeholder="ä¾‹ï¼š\nåœ¨å®…äººå·¥å‘¼å¸å™¨ æ¶ˆè²»é›»åŠ› æ¯”è¼ƒ\nãƒãƒ¼ã‚¿ãƒ–ãƒ«é›»æº ç½å®³æ™‚ æ´»ç”¨äº‹ä¾‹\nã‚½ãƒ¼ãƒ©ãƒ¼ãƒ‘ãƒãƒ« å¤©å€™ å……é›»åŠ¹ç‡"
    )

# ==========================================
# 3. åˆ†æãƒ­ã‚¸ãƒƒã‚¯ (AIè„³)
# ==========================================
if st.button("ğŸš€ æ–‡çŒ®æ¤œç´¢ & é–¢é€£æ€§åˆ†æ", type="primary"):
    if not api_key or not my_theme or not search_query:
        st.error("APIã‚­ãƒ¼ã€ç ”ç©¶ãƒ†ãƒ¼ãƒã€æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã®ã™ã¹ã¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    else:
        # --- A. DuckDuckGoã§æ¤œç´¢ ---
        search_results = ""
        try:
            with st.spinner(f"æ–‡çŒ®ãƒ»æƒ…å ±ã‚’æ¤œç´¢ä¸­... ({search_query})"):
                with DDGS() as ddgs:
                    # å­¦è¡“çš„ãªæƒ…å ±ã‚’å„ªå…ˆã™ã‚‹ãŸã‚ "è«–æ–‡" "report" ãªã©ã‚’è£ã§è¶³ã—ã¦ã‚‚è‰¯ã„
                    results = list(ddgs.text(f"{search_query}", region='jp-jp', max_results=5))
                    for i, r in enumerate(results):
                        search_results += f"ã€æ–‡çŒ®{i+1}ã€‘\nTitle: {r['title']}\nURL: {r['href']}\nSummary: {r['body']}\n\n"
        except Exception as e:
            st.error(f"æ¤œç´¢ã‚¨ãƒ©ãƒ¼: {e}")
            st.stop()

        # --- B. Geminiã§åˆ†æ ---
        prompt = f"""
        ã‚ãªãŸã¯å„ªç§€ãªå¤§å­¦é™¢ç”Ÿã®ç ”ç©¶ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ï¼ˆPh.D.å€™è£œç”Ÿãƒ¬ãƒ™ãƒ«ï¼‰ã§ã™ã€‚
        ä»¥ä¸‹ã®ã€Œæ¤œç´¢ã•ã‚ŒãŸæ–‡çŒ®ã€ã‚’èª­ã¿è¾¼ã¿ã€ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç ”ç©¶ãƒ†ãƒ¼ãƒã€ã«ã¨ã£ã¦ã©ã®ã‚ˆã†ãªä¾¡å€¤ãŒã‚ã‚‹ã‹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

        ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç ”ç©¶ãƒ†ãƒ¼ãƒã€‘
        {my_theme}

        ã€æ¤œç´¢ã•ã‚ŒãŸæ–‡çŒ®ãƒªã‚¹ãƒˆã€‘
        {search_results}

        ã€å‘½ä»¤ã€‘
        1. **ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³å³ç¦**: æ¤œç´¢çµæœã«å«ã¾ã‚Œã‚‹æƒ…å ±ã®ã¿ã‚’äº‹å®Ÿã¨ã—ã¦æ‰±ã£ã¦ãã ã•ã„ã€‚
        2. **å®¢è¦³çš„å¼•ç”¨**: é‡è¦ãªæ•°å€¤ã‚„äº‹å®Ÿã¯ã€å¿…ãšã€Œã©ã®æ–‡çŒ®(URL)ã€ã‹ã‚‰ã®æƒ…å ±ã‹æ˜è¨˜ã—ã¦ãã ã•ã„ã€‚
        3. **é–¢é€£æ€§åˆ†æ (æœ€é‡è¦)**: å˜ãªã‚‹è¦ç´„ã§ã¯ãªãã€ã€Œã“ã®æ–‡çŒ®ã®æƒ…å ±ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®Ÿé¨“ã‚„è«–è¨¼ã«ã©ã†ä½¿ãˆã‚‹ã‹ï¼Ÿï¼ˆã¾ãŸã¯åè«–ææ–™ã«ãªã‚‹ã‹ï¼Ÿï¼‰ã€ã‚’å…·ä½“çš„ã«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ãã ã•ã„ã€‚

        ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
        ## ğŸ“Š åˆ†æãƒ¬ãƒãƒ¼ãƒˆ
        
        ### 1. æ¤œç´¢çµæœã®æ¦‚è¦ (Summary)
        (æ¤œç´¢ã•ã‚ŒãŸæ–‡çŒ®ã®è¦ç‚¹ã‚’3è¡Œã§)

        ### 2. ç ”ç©¶ãƒ†ãƒ¼ãƒã¨ã®é–¢é€£æ€§ãƒ»æ´»ç”¨æ³• (Relevance)
        - **[æ–‡çŒ®ã‚¿ã‚¤ãƒˆãƒ«]**: 
            - æ´»ç”¨ãƒã‚¤ãƒ³ãƒˆ: ï¼ˆä¾‹ï¼šã‚ãªãŸã®å®Ÿé¨“ã®å…ˆè¡Œç ”ç©¶ã¨ã—ã¦å¼•ç”¨å¯èƒ½ã§ã™ï¼‰
            - å…·ä½“çš„å†…å®¹: ï¼ˆè¦ç´„ï¼‰
        
        ### 3. å®¢è¦³çš„äº‹å®Ÿãƒ»ãƒ‡ãƒ¼ã‚¿ (Facts)
        - (æ•°å€¤ãƒ‡ãƒ¼ã‚¿ã‚„é‡è¦ãªå®šç¾©ãªã©ã‚’ç®‡æ¡æ›¸ãã§å¼•ç”¨)

        ### 4. æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ææ¡ˆ
        - (ã“ã®çµæœã‚’è¸ã¾ãˆã¦ã€æ¬¡ã«ä½•ã‚’èª¿ã¹ã‚‹ã¹ãã‹ã€å®Ÿé¨“è¨ˆç”»ã‚’ã©ã†ä¿®æ­£ã™ã¹ãã‹)
        """

        try:
            model = genai.GenerativeModel("gemini-1.5-pro")
            with st.spinner("è«–æ–‡ã¨ç ”ç©¶ãƒ†ãƒ¼ãƒã‚’ç…§åˆä¸­..."):
                response = model.generate_content(prompt)
            
            st.markdown(response.text)
            
            with st.expander("ğŸ“š å‚ç…§ã—ãŸæ–‡çŒ®ã‚½ãƒ¼ã‚¹ (Raw Data)"):
                st.text(search_results)

        except Exception as e:
            st.error(f"AIåˆ†æã‚¨ãƒ©ãƒ¼: {e}")
